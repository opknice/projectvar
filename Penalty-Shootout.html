<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title data-lang="appTitle">Penalty Shootout UI</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: white;
      font-family: sans-serif;
      padding: 1rem;
      text-align: center;
    }
    .row { display: flex; justify-content: space-between; margin-bottom: 1rem; }
    .team { flex: 1; }
    .dots { display: flex; justify-content: center; gap: 8px; margin: 0.5rem 0; }
    .dot { width: 20px; height: 20px; border-radius: 50%; background-color: transparent; border: 2px solid #666; opacity: 0.5; }
    .dot.goal { background-color: limegreen; opacity: 1; }
    .dot.miss { background-color: crimson; opacity: 1; }
    .score { font-size: 1.1rem; font-weight: bold; margin-top: 0.3rem; }
    .controls.vertical { display: flex; flex-direction: row; justify-content: center; gap: 40px; margin-top: 0.5rem; }
    .controls .side { display: flex; flex-direction: column; gap: 10px; }
    button { padding: 0.4rem 0.8rem; font-size: 0.9rem; border-radius: 6px; border: none; cursor: pointer; }
    .goal-btn { background-color: #4CAF50; color: white; }
    .miss-btn { background-color: #F44336; color: white; }
    .undo-btn { background-color: #888; color: white; }
    .reset { margin-top: 1rem; background-color: darkred; color: white; }

    /* Styles for Popup Modals */
    dialog {
        background: #2c2c2c;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        max-width: 400px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }
    dialog::backdrop {
        background: rgba(0, 0, 0, 0.7);
    }
    dialog h2, dialog h3 {
        color: #e0e0e0;
        margin-top: 0;
        font-size: 1.2rem;
        margin-bottom: 15px;
    }
    dialog p {
        font-size: 0.9rem;
        color: #a0a0a0;
        margin-bottom: 12px;
    }
    dialog code {
        background-color: #1a1a1a;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Courier New', Courier, monospace;
        color: #3b82f6;
        font-weight: bold;
        display: inline-block;
        word-break: break-all;
    }
    .setting-panel input[type="number"],
    .setting-panel select {
      width: 60px; padding: 0.2rem; text-align: center;
      background: #1a1a1a; color: white; border: 1px solid #3a3a3a; border-radius: 6px;
    }
    .setting-panel label { display: block; margin-bottom: 8px; }
    .setting-panel fieldset { border: 1px solid #3a3a3a; border-radius: 4px; padding: 10px; margin-top: 15px; }
    .setting-panel legend { color: #a0a0a0; font-size: 0.9rem; padding: 0 5px; }
    .setting-panel input[type="radio"] { margin-right: 5px; }
    .dialog-buttons { margin-top: 1rem; text-align: right; }
    .dialog-buttons button { margin-left: 10px; }

    /* Specific styles for lists in popups */
    .item-list { margin-top: 15px; padding-top: 10px; border-top: 1px solid #3a3a3a; }
    .item-list h4 { margin: 0 0 10px 0; font-size: 0.95rem; color: #e0e0e0; font-weight: 500; display: flex; align-items: center; gap: 6px; }
    .item-list ul { list-style: none; padding-left: 0; margin-top: 0; }
    .item-list li { margin-bottom: 8px; font-size: 0.9rem; color: #a0a0a0; }
    .item-list li strong { color: #3b82f6; }
    .item-list li ul { list-style: disc; padding-left: 20px; margin-top: 5px; }
    .changelog-list { list-style: none; padding-left: 0; }
    .changelog-list li { margin-bottom: 15px; }
    .changelog-list h5 { margin: 0 0 5px 0; font-size: 1rem; color: #3b82f6; }
    .changelog-list ul { list-style-type: disc; padding-left: 20px; margin: 0; }
    .changelog-list ul li { margin-bottom: 3px; font-size: 0.9rem; color: #a0a0a0; }

    /* Footer for OBS Dock UI - Penalty by JAMORNzMedia */
    .app-footer {
      text-align: center;
      color: #a0a0a0;
      font-size: 0.75rem;
      padding: 10px;
      margin-top: 20px;
    }
    .app-footer a {
      color: #7ab8f3;
      text-decoration: none;
      cursor: pointer;
    }
    .app-footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="row">
    <div class="team">
      <h3><span data-lang="teamA">Team A</span></h3>
      <div class="dots" id="dotsA"></div>
      <div class="score"><span data-lang="scoreLabel">Score</span>: <span id="scoreA">0</span></div>
    </div>
    <div class="team">
      <h3><span data-lang="teamB">Team B</span></h3>
      <div class="dots" id="dotsB"></div>
      <div class="score"><span data-lang="scoreLabel">Score</span>: <span id="scoreB">0</span></div>
    </div>
  </div>

  <div id="controlPanel" class="controls vertical">
    <div class="side">
      <button class="goal-btn" onclick="shoot('A', true)"><span data-lang="goalBtn">Goal A</span></button>
      <button class="miss-btn" onclick="shoot('A', false)"><span data-lang="missBtn">Miss A</span></button>
      <button class="undo-btn" onclick="undo('A')"><span data-lang="undoBtn">Undo A</span></button>
    </div>
    <div class="side">
      <button class="goal-btn" onclick="shoot('B', true)"><span data-lang="goalBtn">Goal B</span></button>
      <button class="miss-btn" onclick="shoot('B', false)"><span data-lang="missBtn">Miss B</span></button>
      <button class="undo-btn" onclick="undo('B')"><span data-lang="undoBtn">Undo B</span></button>
    </div>
  </div>

  <button class="reset" onclick="reset()"><span data-lang="resetAllBtn">Reset All</span></button>
  <button onclick="document.getElementById('settingDialog').showModal()">‚öôÔ∏è <span data-lang="settingsBtn">Settings</span></button>
  <button onclick="document.getElementById('helpDialog').showModal()">‚ùì <span data-lang="helpBtn">Help</span></button>

  <select id="languageSelector" style="margin-top: 1rem; padding: 0.4rem 0.8rem; border-radius: 6px; background-color: #4a4a4a; color: white; border: none;">
    <option value="th">‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</option>
    <option value="en">English</option>
  </select>

  <dialog id="settingDialog">
    <form method="dialog">
      <h2><span data-lang="settingsTitle">Settings</span></h2>
      <div class="setting-panel">
        <label><span data-lang="dotSizeLabel">Dot Size</span>: <input type="number" id="dotSize" min="10" max="100"> px</label>
        <label><span data-lang="dotGapLabel">Dot Gap</span>: <input type="number" id="dotGap" min="0" max="100"> px</label>
        <label><span data-lang="teamGapLabel">Team Gap</span>: <input type="number" id="teamGap" min="0" max="200"> px</label>

        <fieldset>
          <legend><span data-lang="graphicLayoutLabel">Graphic Layout</span></legend>
          <label><input type="radio" name="layout" value="side-by-side" id="layoutSideBySide"> <span data-lang="layoutSideBySide">Side-by-Side (‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤)</span></label><br>
          <label><input type="radio" name="layout" value="top-bottom" id="layoutTopBottom"> <span data-lang="layoutTopBottom">Top-Bottom (‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á)</span></label>
        </fieldset>

        <div class="dialog-buttons">
          <button type="button" onclick="updateSettings()"><span data-lang="applyBtn">Apply</span></button>
          <button type="submit"><span data-lang="closeBtn">Close</span></button>
        </div>
      </div>
    </form>
  </dialog>

  <dialog id="helpDialog">
    <form method="dialog">
      <h2><span data-lang="helpTitle">Help / How to Use with OBS</span></h2>
      <p><span data-lang="helpIntro">This control panel sends score and penalty shot data to OBS. To display them, you need to set up the following sources in OBS.</span></p>

      <div class="item-list">
        <h4><span data-lang="obsSourcesTitle">OBS Sources Needed</span></h4>
        <ul>
          <li><strong><span data-lang="scoreASource">Score_A</span></strong><br><span data-lang="scoreATextSourceDesc"> (Text (GDI+) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡∏° A)</span></li>
          <li><strong><span data-lang="scoreBSource">Score_B</span></strong><br><span data-lang="scoreBTextSourceDesc"> (Text (GDI+) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡∏° B)</span></li>
          <li><strong><span data-lang="penaltyDotsSource">Penalty_Dots_AB</span></strong><br><span data-lang="browserSourceDesc"> (Browser source ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡∏¢‡∏¥‡∏á‡∏à‡∏∏‡∏î‡πÇ‡∏ó‡∏©)</span><br>
            <span data-lang="browserSourceUrlLabel">URL:</span> <code>https://jamornzmedia.github.io/obs-dock-ui/dots_AB.html</code><br>
            <span data-lang="browserSourceNote"><em>(In OBS, you can move it to any desired position or Crop ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Å‡∏î Alt + ‡∏•‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏Å‡∏£‡∏≠‡∏ö Source ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á)</em></span>
          </li>
        </ul>
      </div>

      <div class="item-list" style="margin-top: 25px;">
        <h4><span data-lang="settingsExplanationTitle">Settings Explained</span></h4>
        <ul>
          <li><strong><span data-lang="dotSizeLabel">Dot Size (px)</span>:</strong> <span data-lang="dotSizeDesc">‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•).</span></li>
          <li><strong><span data-lang="dotGapLabel">Dot Gap (px)</span>:</strong> <span data-lang="dotGapDesc">‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏∏‡∏î‡πÉ‡∏ô‡∏ó‡∏µ‡∏° (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•).</span></li>
          <li><strong><span data-lang="teamGapLabel">Team Gap (px)</span>:</strong> <span data-lang="teamGapDesc">‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏° A ‡πÅ‡∏•‡∏∞ B (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•). ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô.</span></li>
          <li><strong><span data-lang="graphicLayoutLabel">Graphic Layout</span>:</strong> <span data-lang="layoutDesc">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡∏à‡∏∏‡∏î.</span>
            <ul>
              <li><strong><span data-lang="layoutSideBySide">Side-by-Side (‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤)</span>:</strong> <span data-lang="layoutSideBySideDesc">‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡∏° A ‡πÅ‡∏•‡∏∞ B ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô.</span></li>
              <li><strong><span data-lang="layoutTopBottom">Top-Bottom (‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á)</span>:</strong> <span data-lang="layoutTopBottomDesc">‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡∏° A ‡πÅ‡∏™‡∏î‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡∏° B ‡πÅ‡∏™‡∏î‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á.</span></li>
            </ul>
          </li>
        </ul>
      </div>
      <div class="dialog-buttons">
        <button type="submit"><span data-lang="closeBtn">Close</span></button>
      </div>
    </form>
  </dialog>

  <dialog id="versionHistoryDialog">
    <form method="dialog">
      <h2><span data-lang="versionHistoryTitle">Version History</span></h2>
      <div class="changelog-list">
        <ul>
          <li>
            <h5><span data-lang="version1_1">Version 1.1</span></h5>
            <ul>
              <li><span data-lang="v1_1_feature1">Enhanced shot history: now remembers all shots.</span></li>
              <li><span data-lang="v1_1_feature2">Added "Help" button with OBS source setup guide and detailed settings explanations.</span></li>
              <li><span data-lang="v1_1_feature3">Introduced graphic layout options (Side-by-Side / Top-Bottom) in Settings.</span></li>
              <li><span data-lang="v1_1_feature4">Team Gap now correctly applies to both horizontal and vertical layouts.</span></li>
              <li><span data-lang="v1_1_feature5">Graphics will visually reset to empty dots when a team starts a new set of 5 shots (e.g., 6th shot).</span></li>
            </ul>
          </li>
          <li>
            <h5><span data-lang="version1_0">Version 1.0</span></h5>
            <ul>
              <li><span data-lang="v1_0_feature1">Basic score counting and penalty dot display (up to 5 shots per set).</span></li>
              <li><span data-lang="v1_0_feature2">Control buttons: Goal, Miss, Undo for each team.</span></li>
              <li><span data-lang="v1_0_feature3">"Reset All" button to clear scores and dots.</span></li>
              <li><span data-lang="v1_0_feature4">OBS WebSocket integration for updating Text Sources (Score_A, Score_B).</span></li>
              <li><span data-lang="v1_0_feature5">Customizable dot size, dot gap, and team gap via Settings.</span></li>
              <li><span data-lang="v1_0_feature6">Broadcast of display data and settings to OBS Browser Source using BroadcastChannel.</span></li>
            </ul>
          </li>
        </ul>
      </div>
      <div class="dialog-buttons">
        <button type="submit"><span data-lang="closeBtn">Close</span></button>
      </div>
    </form>
  </dialog>
  
  <div class="app-footer">
    OBS Dock UI - Penalty by JAMORNzMedia <br>
    <a href="#" onclick="document.getElementById('versionHistoryDialog').showModal()"><span data-lang="versionText">Version 1.1</span></a>
  </div>

  <script>
    const MAX_SHOTS_DISPLAY = 5; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏¢‡∏¥‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö (5 ‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≠ Page)
    let shots = { A: [[]], B: [[]] }; // ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô Page: shots.A[page_index][shot_index]
    let scores = { A: 0, B: 0 };
    let currentPage = 0; // Index ‡∏Ç‡∏≠‡∏á Page ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0)

    const channel = new BroadcastChannel("penalty_channel");
    let obs;

    const OBS_URL = "ws://localhost:4455";
    const OBS_PASSWORD = "supersecret"; // üîí ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô OBS WebSocket

    // --- Localization Data ---
    const translations = {
      th: {
        appTitle: "Penalty Shootout UI", 
        versionText: "‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô 1.1",
        teamA: "‡∏ó‡∏µ‡∏° A",
        teamB: "‡∏ó‡∏µ‡∏° B",
        scoreLabel: "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô",
        goalBtn: "‡πÄ‡∏Ç‡πâ‡∏≤ A",
        missBtn: "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ A",
        undoBtn: "‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö A",
        resetAllBtn: "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
        settingsBtn: "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤",
        helpBtn: "‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠",
        closeBtn: "‡∏õ‡∏¥‡∏î",
        applyBtn: "‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ",
        settingsTitle: "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤",
        dotSizeLabel: "‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏∏‡∏î",
        dotGapLabel: "‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏∏‡∏î",
        teamGapLabel: "‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡∏°",
        graphicLayoutLabel: "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å",
        layoutSideBySide: "‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤",
        layoutTopBottom: "‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á",
        helpTitle: "‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ / ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö OBS",
        helpIntro: "‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏¢‡∏¥‡∏á‡∏à‡∏∏‡∏î‡πÇ‡∏ó‡∏©‡πÑ‡∏õ‡∏¢‡∏±‡∏á OBS ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Source ‡∏î‡∏±‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô OBS.",
        obsSourcesTitle: "OBS Sources ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô",
        scoreASource: "Score_A",
        scoreBSource: "Score_B",
        scoreATextSourceDesc: "(Text (GDI+) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡∏° A)",
        scoreBTextSourceDesc: "(Text (GDI+) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡∏° B)",
        penaltyDotsSource: "Penalty_Dots_AB",
        browserSourceDesc: "(Browser source ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡∏¢‡∏¥‡∏á‡∏à‡∏∏‡∏î‡πÇ‡∏ó‡∏©)",
        browserSourceUrlLabel: "URL:",
        browserSourceNote: "<em>(‡πÉ‡∏ô OBS ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ ‡∏Ç‡∏¢‡∏±‡∏ö‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ Crop ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Å‡∏î Alt + ‡∏•‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏Å‡∏£‡∏≠‡∏ö Source ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á)</em>",
        settingsExplanationTitle: "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤",
        dotSizeDesc: "‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•).",
        dotGapDesc: "‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏∏‡∏î‡πÉ‡∏ô‡∏ó‡∏µ‡∏° (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•).",
        teamGapDesc: "‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏° A ‡πÅ‡∏•‡∏∞ B (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•). ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô.",
        layoutDesc: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡∏à‡∏∏‡∏î.",
        layoutSideBySideDesc: "‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡∏° A ‡πÅ‡∏•‡∏∞ B ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô.",
        layoutTopBottomDesc: "‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡∏° A ‡πÅ‡∏™‡∏î‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡∏° B ‡πÅ‡∏™‡∏î‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á.",
        versionHistoryTitle: "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô",
        version1_1: "‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô 1.1",
        v1_1_feature1: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏î‡∏à‡∏≥‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á‡∏ó‡∏∏‡∏Å‡∏•‡∏π‡∏Å.",
        v1_1_feature2: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° \"Help\" ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ OBS Source (Text, Browser) ‡πÅ‡∏•‡∏∞ URL ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô.",
        v1_1_feature3: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡∏à‡∏∏‡∏î (‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ / ‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á) ‡πÉ‡∏ô Settings.",
        v1_1_feature4: "‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡∏° (Team Gap) ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å.",
        v1_1_feature5: "‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡πÉ‡∏î‡∏ó‡∏µ‡∏°‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• 5 ‡∏•‡∏π‡∏Å‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà 6).",
        version1_0: "‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô 1.0",
        v1_0_feature1: "‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏∏‡∏î‡∏¢‡∏¥‡∏á‡∏à‡∏∏‡∏î‡πÇ‡∏ó‡∏© (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≠‡∏ä‡∏∏‡∏î).",
        v1_0_feature2: "‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°: ‡πÄ‡∏Ç‡πâ‡∏≤, ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤, ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏µ‡∏°.",
        v1_0_feature3: "‡∏õ‡∏∏‡πà‡∏° \"‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏¢‡∏¥‡∏á.",
        v1_0_feature4: "‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö OBS WebSocket ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô Text Source.",
        v1_0_feature5: "‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏∏‡∏î, ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏∏‡∏î, ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡∏° ‡∏ú‡πà‡∏≤‡∏ô Settings.",
        v1_0_feature6: "‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á Browser Source ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OBS ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ BroadcastChannel.",
      },
      en: {
        appTitle: "Penalty Shootout UI",
        versionText: "Version 1.1",
        teamA: "Team A",
        teamB: "Team B",
        scoreLabel: "Score",
        goalBtn: "Goal A",
        missBtn: "Miss A",
        undoBtn: "Undo A",
        resetAllBtn: "Reset All",
        settingsBtn: "Settings",
        helpBtn: "Help",
        closeBtn: "Close",
        applyBtn: "Apply",
        settingsTitle: "Settings",
        dotSizeLabel: "Dot Size",
        dotGapLabel: "Dot Gap",
        teamGapLabel: "Team Gap",
        graphicLayoutLabel: "Graphic Layout",
        layoutSideBySide: "Side-by-Side (Left-Right)",
        layoutTopBottom: "Top-Bottom (Up-Down)",
        helpTitle: "Help / How to Use with OBS",
        helpIntro: "This control panel sends score and penalty shot data to OBS. To display them, you need to set up the following sources in OBS.",
        obsSourcesTitle: "OBS Sources Needed",
        scoreASource: "Score_A",
        scoreBSource: "Score_B",
        scoreATextSourceDesc: "(Text (GDI+) for Team A's score)",
        scoreBTextSourceDesc: "(Text (GDI+) for Team B's score)",
        penaltyDotsSource: "Penalty_Dots_AB",
        browserSourceDesc: "(Browser source for penalty dots graphic)",
        browserSourceUrlLabel: "URL:",
        browserSourceNote: "<em>(In OBS, you can move it to any desired position or Crop it by holding Alt + dragging the source's border.)</em>",
        settingsExplanationTitle: "Settings Explained",
        dotSizeDesc: "Diameter of the penalty dot display (pixels).",
        dotGapDesc: "Spacing between each penalty dot within a team (pixels).",
        teamGapDesc: "Spacing between Team A's and Team B's dot groups (pixels). This applies to both vertical and horizontal layouts.",
        layoutDesc: "Choose the arrangement of the penalty dot graphic.",
        layoutSideBySideDesc: "Team A and B dots are displayed next to each other.",
        layoutTopBottomDesc: "Team A dots are displayed above Team B dots.",
        versionHistoryTitle: "Version History",
        version1_1: "Version 1.1",
        v1_1_feature1: "Enhanced shot history: now remembers all shots.",
        v1_1_feature2: "Added \"Help\" button with concise OBS source setup guide and detailed settings explanations.",
        v1_1_feature3: "Introduced graphic layout options (Side-by-Side / Top-Bottom) in Settings.",
        v1_1_feature4: "Team Gap now correctly applies to both horizontal and vertical layouts.",
        v1_1_feature5: "Graphics will visually reset to empty dots when a team starts a new set of 5 shots (e.g., 6th shot).",
        version1_0: "Version 1.0",
        v1_0_feature1: "Basic score counting and penalty dot display (up to 5 shots per set).",
        v1_0_feature2: "Control buttons: Goal, Miss, Undo for each team.",
        v1_0_feature3: " \"Reset All\" button to clear scores and dots.",
        v1_0_feature4: "OBS WebSocket integration for updating Text Sources (Score_A, Score_B).",
        v1_0_feature5: "Customizable dot size, dot gap, and team gap via Settings.",
        v1_0_feature6: "Broadcast of display data and settings to OBS Browser Source using BroadcastChannel.",
      }
    };

    function applyTranslations(lang) {
      document.title = translations[lang].appTitle;
      const elements = document.querySelectorAll('[data-lang]');
      elements.forEach(el => {
        const key = el.getAttribute('data-lang');
        if (translations[lang] && translations[lang][key]) {
          el.textContent = translations[lang][key];
        }
      });

      const htmlElements = document.querySelectorAll('[data-lang-html]');
      htmlElements.forEach(el => {
          const key = el.getAttribute('data-lang-html');
          if (translations[lang] && translations[lang][key]) {
              el.innerHTML = translations[lang][key];
          }
      });
    }

    const languageSelector = document.getElementById('languageSelector');
    languageSelector.addEventListener('change', (event) => {
      const selectedLang = event.target.value;
      localStorage.setItem('penalty_language', selectedLang);
      applyTranslations(selectedLang);
    });

    // --- OBS WebSocket Connection ---
    function connectOBS() {
      obs = new WebSocket(OBS_URL);

      obs.onopen = () => {
        console.log("üü° Connecting to OBS...");
      };

      obs.onmessage = async (event) => {
        const message = JSON.parse(event.data);
        if (message.op === 0) {
          const authRequest = {
            op: 1,
            d: {
              rpcVersion: 1,
              authentication: OBS_PASSWORD ? {
                secret: OBS_PASSWORD
              } : undefined
            }
          };
          obs.send(JSON.stringify(authRequest));
        } else if (message.op === 2) {
          console.log("‚úÖ Connected to OBS WebSocket!");
        }
      };

      obs.onerror = (err) => {
        console.error("‚ùå OBS WebSocket error:", err);
      };

      obs.onclose = () => {
        console.log("‚ùå OBS WebSocket disconnected. Attempting to reconnect in 5 seconds...");
        setTimeout(connectOBS, 5000);
      };
    }

    function updateOBSScore(team, value) {
      if (!obs || obs.readyState !== 1) return;
      const sourceName = team === 'A' ? "Score_A" : "Score_B";
      obs.send(JSON.stringify({
        op: 6,
        d: {
          requestType: "SetInputSettings",
          requestId: `update-score-${team}`,
          requestData: {
            inputName: sourceName,
            inputSettings: { text: value.toString() },
            overlay: true
          }
        }
      }));
    }

    // --- UI Rendering (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Render ‡∏à‡∏∏‡∏î‡∏ö‡∏ô UI Control Panel ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ---
    function renderDotsUI(container, shotsToRender) {
      container.innerHTML = "";
      
      for (let i = 0; i < MAX_SHOTS_DISPLAY; i++) {
        const dot = document.createElement("div");
        dot.className = "dot";
        const shot = shotsToRender[i];
        if (shot === true) dot.classList.add("goal");
        else if (shot === false) dot.classList.add("miss");
        container.appendChild(dot);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á 5 ‡∏•‡∏π‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á Page ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    function getShotsForCurrentPage(team) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Page ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà ‡∏Å‡πá‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ 5 ‡∏ä‡πà‡∏≠‡∏á
        if (!shots[team][currentPage]) {
            return Array(MAX_SHOTS_DISPLAY).fill(null);
        }
        const pageShots = shots[team][currentPage];
        const displayArray = Array(MAX_SHOTS_DISPLAY).fill(null);
        // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å Page ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        for (let i = 0; i < pageShots.length; i++) {
            displayArray[i] = pageShots[i];
        }
        return displayArray;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏•‡∏∞ OBS Overlay ‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Page ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    function renderAll() {
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏µ‡∏° A
      const containerA = document.getElementById("dotsA");
      const scoreDisplayA = document.getElementById("scoreA");
      const currentShotsA = getShotsForCurrentPage('A');
      renderDotsUI(containerA, currentShotsA);
      scoreDisplayA.textContent = scores.A;
      updateOBSScore('A', scores.A);

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏µ‡∏° B
      const containerB = document.getElementById("dotsB");
      const scoreDisplayB = document.getElementById("scoreB");
      const currentShotsB = getShotsForCurrentPage('B');
      renderDotsUI(containerB, currentShotsB);
      scoreDisplayB.textContent = scores.B;
      updateOBSScore('B', scores.B);
      
      // ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á Page ‡πÑ‡∏õ‡∏¢‡∏±‡∏á OBS Overlay
      channel.postMessage({
        type: "update",
        data: {
          shotsA: currentShotsA,
          shotsB: currentShotsB,
          settings: getSettings()
        }
      });
    }

    // --- Game Logic ---
    function shoot(team, isGoal) {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏¢‡∏¥‡∏á‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà 6 ‡∏Ç‡∏≠‡∏á Page ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏π‡∏Å‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á Page ‡πÉ‡∏´‡∏°‡πà)
      const isStartingNewPage = (shots[team][currentPage].length === MAX_SHOTS_DISPLAY);

      if (isStartingNewPage) {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Page ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ó‡∏µ‡∏° ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
        currentPage++;
        if (!shots['A'][currentPage]) shots['A'].push([]);
        if (!shots['B'][currentPage]) shots['B'].push([]);

        // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Page ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∏‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á Page ‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        // ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏π‡∏Å‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á Page ‡∏ô‡∏µ‡πâ
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏¢‡∏¥‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô Page ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      shots[team][currentPage].push(isGoal);
      if (isGoal) scores[team]++;
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å renderAll ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÅ‡∏•‡∏∞ OBS
      renderAll();
    }

    function undo(team) {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ undo ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (shots[team][currentPage].length === 0) {
        // ‡∏ñ‡πâ‡∏≤ Page ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Page ‡πÅ‡∏£‡∏Å ‡πÉ‡∏´‡πâ‡∏ñ‡∏≠‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Page ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        if (currentPage > 0) {
          currentPage--;
          // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö Page ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏≠‡∏≠‡∏Å ‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ shoot ‡∏ó‡∏µ‡πà undo ‡πÑ‡∏õ
          // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡∏à‡∏≥‡∏Ñ‡πà‡∏≤ 5 ‡∏•‡∏π‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ renderAll
        } else {
            return; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡πÉ‡∏´‡πâ undo ‡πÅ‡∏•‡πâ‡∏ß
        }
      }

      const last = shots[team][currentPage].pop();
      if (last === true) scores[team]--;
      
      renderAll(); // <--- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å renderAll ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å undo
    }

    function reset() {
      shots = { A: [[]], B: [[]] }; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà Page 0 ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤
      scores = { A: 0, B: 0 };
      currentPage = 0; // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Page ‡πÅ‡∏£‡∏Å
      renderAll(); // <--- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å renderAll ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å reset
    }

    // --- Settings Management ---
    function getSettings() {
      return {
        dotSize: document.getElementById('dotSize').value,
        dotGap: document.getElementById('dotGap').value,
        teamGap: document.getElementById('teamGap').value,
        layout: document.querySelector('input[name="layout"]:checked').value
      };
    }

    function updateSettings() {
      const settings = getSettings();
      localStorage.setItem("penalty_settings", JSON.stringify(settings));
      renderAll(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á Overlay
    }

    function loadSettings() {
      const saved = JSON.parse(localStorage.getItem("penalty_settings"));
      if (saved) {
        document.getElementById('dotSize').value = saved.dotSize;
        document.getElementById('dotGap').value = saved.dotGap;
        document.getElementById('teamGap').value = saved.teamGap;
        document.getElementById('layoutSideBySide').checked = (saved.layout === 'side-by-side');
        document.getElementById('layoutTopBottom').checked = (saved.layout === 'top-bottom');
      } else {
        document.getElementById('dotSize').value = 20;
        document.getElementById('dotGap').value = 8;
        document.getElementById('teamGap').value = 80;
        document.getElementById('layoutSideBySide').checked = true;
      }
      renderAll(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á Overlay
    }

    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
      const savedLang = localStorage.getItem('penalty_language') || 'th';
      languageSelector.value = savedLang;
      applyTranslations(savedLang);

      connectOBS();
      loadSettings();
      reset(); // ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ OBS display ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏±‡∏ô
    });
  </script>
</body>
</html>