<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แปลงไฟล์ JFIF เป็น JPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .drop-zone {
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: scale(1.02);
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl overflow-hidden">
        <!-- Header -->
        <div class="bg-blue-600 p-6 text-white text-center">
            <h1 class="text-3xl font-bold mb-2">แปลงไฟล์ JFIF เป็น JPG</h1>
            <p class="text-blue-100">อัปโหลดไฟล์ .jfif ของคุณแล้วแปลงเป็น .jpg คุณภาพสูงได้ทันที</p>
        </div>

        <div class="p-6 md:p-8 space-y-6">
            
            <!-- Upload Area -->
            <div id="dropZone" class="drop-zone border-3 border-dashed border-gray-300 rounded-xl p-10 text-center cursor-pointer hover:border-blue-400 bg-gray-50 relative">
                <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" multiple accept=".jfif,image/jpeg,image/*">
                <div class="space-y-3 pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="text-lg text-gray-700 font-semibold">ลากไฟล์มาวางที่นี่ หรือ คลิกเพื่อเลือกไฟล์</p>
                    <p class="text-sm text-gray-500">รองรับไฟล์ JFIF, JPEG (เลือกได้หลายไฟล์พร้อมกัน)</p>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 border-b pb-6" id="controlsArea" style="display: none;">
                <div class="text-gray-700">
                    <span id="fileCount" class="font-bold text-blue-600">0</span> ไฟล์พร้อมแปลง
                </div>
                <div class="flex gap-3">
                    <button onclick="clearAll()" class="px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg transition border border-red-200">
                        ล้างทั้งหมด
                    </button>
                    <button id="downloadAllBtn" onclick="downloadAllZip()" class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg shadow transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        ดาวน์โหลดทั้งหมด (.ZIP)
                    </button>
                </div>
            </div>

            <!-- File List -->
            <div id="fileList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[500px] overflow-y-auto pr-2">
                <!-- Items will be injected here -->
            </div>

        </div>
        
        <!-- Footer -->
        <div class="bg-gray-50 p-4 text-center text-gray-500 text-sm border-t">
            ประมวลผลบนเบราว์เซอร์ของคุณ 100% (ไฟล์ไม่ได้ถูกส่งไปยังเซิร์ฟเวอร์)
        </div>
    </div>

    <!-- Hidden Canvas for Conversion -->
    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const controlsArea = document.getElementById('controlsArea');
        const fileCountSpan = document.getElementById('fileCount');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        
        let processedFiles = []; // Store blobs for zip download

        // Event Listeners for Drag & Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            // Reset input so same files can be selected again if needed
            fileInput.value = ''; 
        });

        async function handleFiles(files) {
            if (files.length === 0) return;

            controlsArea.style.display = 'flex';
            
            // Process each file
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.match('image.*') && !file.name.toLowerCase().endsWith('.jfif')) {
                    continue; // Skip non-images
                }
                
                await processImage(file);
            }
            
            updateUI();
        }

        function createListItem(file, id) {
            const div = document.createElement('div');
            div.className = "bg-white border rounded-lg p-3 shadow-sm flex items-center gap-3 relative overflow-hidden group";
            div.id = `item-${id}`;
            div.innerHTML = `
                <div class="h-16 w-16 bg-gray-200 rounded-md overflow-hidden flex-shrink-0 flex items-center justify-center relative">
                    <div id="spinner-${id}" class="absolute inset-0 flex items-center justify-center bg-gray-100 z-10">
                        <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <img id="img-${id}" class="h-full w-full object-cover opacity-0 transition-opacity duration-300" src="" alt="preview">
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate" title="${file.name}">${file.name}</p>
                    <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</p>
                    <p class="text-xs text-green-600 font-semibold mt-1 hidden" id="status-${id}">✓ แปลงสำเร็จ</p>
                </div>
                <a id="download-${id}" class="hidden p-2 text-blue-600 hover:bg-blue-50 rounded-full transition" title="ดาวน์โหลด">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </a>
            `;
            fileList.appendChild(div);
            return div;
        }

        async function processImage(file) {
            const id = Date.now() + Math.random().toString(36).substr(2, 9);
            createListItem(file, id);

            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Create canvas
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        
                        // Draw image (this handles the conversion internally in the browser)
                        ctx.drawImage(img, 0, 0);

                        // Convert to JPG Blob
                        canvas.toBlob((blob) => {
                            const newFileName = file.name.replace(/\.[^/.]+$/, "") + ".jpg";
                            
                            // Save to processed list
                            processedFiles.push({
                                name: newFileName,
                                blob: blob
                            });

                            // Update UI Item
                            const imgElem = document.getElementById(`img-${id}`);
                            imgElem.src = URL.createObjectURL(blob);
                            imgElem.classList.remove('opacity-0');
                            
                            const spinner = document.getElementById(`spinner-${id}`);
                            spinner.style.display = 'none';

                            const status = document.getElementById(`status-${id}`);
                            status.classList.remove('hidden');

                            const downloadLink = document.getElementById(`download-${id}`);
                            downloadLink.href = imgElem.src;
                            downloadLink.download = newFileName;
                            downloadLink.classList.remove('hidden');
                            downloadLink.classList.add('flex');

                            updateUI();
                            resolve();
                        }, 'image/jpeg', 0.95); // 0.95 Quality
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function updateUI() {
            fileCountSpan.innerText = processedFiles.length;
            if (processedFiles.length > 0) {
                downloadAllBtn.disabled = false;
            } else {
                downloadAllBtn.disabled = true;
                controlsArea.style.display = 'none';
            }
        }

        function clearAll() {
            fileList.innerHTML = '';
            processedFiles = [];
            updateUI();
            // Optional: revoke object URLs to free memory if list was huge
        }

        async function downloadAllZip() {
            if (processedFiles.length === 0) return;

            const zip = new JSZip();
            const btnOriginalText = downloadAllBtn.innerHTML;
            
            // Set loading state
            downloadAllBtn.disabled = true;
            downloadAllBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                กำลังบีบอัดไฟล์...
            `;

            // Add files to zip
            processedFiles.forEach(file => {
                zip.file(file.name, file.blob);
            });

            // Generate and save
            try {
                const content = await zip.generateAsync({type: "blob"});
                saveAs(content, "converted_images.zip");
            } catch (err) {
                alert("เกิดข้อผิดพลาดในการสร้างไฟล์ Zip");
                console.error(err);
            } finally {
                // Reset button
                downloadAllBtn.disabled = false;
                downloadAllBtn.innerHTML = btnOriginalText;
            }
        }
    </script>
</body>
</html>